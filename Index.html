<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Moviezonex</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <style>
        :root { --bg: #0f0f0f; --card-bg: #1a1a1a; --accent: #e50914; --glass: rgba(20, 20, 20, 0.9); }
        body { background: var(--bg); color: #fff; margin: 0; padding-bottom: 80px; font-family: sans-serif; -webkit-tap-highlight-color: transparent; }
        
        /* HEADER */
        header { position: sticky; top: 0; z-index: 50; background: var(--glass); backdrop-filter: blur(10px); padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #333; }
        .logo { font-size: 22px; font-weight: 800; color: var(--accent); letter-spacing: 1px; }
        
        .search-container { display: flex; align-items: center; gap: 10px; }
        #search-input { 
            background: #333; border: 1px solid #444; color: white; 
            padding: 8px 15px; border-radius: 20px; outline: none; 
            width: 0; opacity: 0; transition: 0.3s ease; visibility: hidden;
        }
        #search-input.active { width: 150px; opacity: 1; visibility: visible; }
        .search-btn { background: #333; border: none; color: white; width: 35px; height: 35px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; }

        /* CAROUSEL */
        .carousel-scene { height: 340px; display: flex; justify-content: center; align-items: center; overflow: hidden; perspective: 1000px; margin-top: 10px; }
        .carousel { width: 200px; height: 300px; position: relative; transform-style: preserve-3d; transition: transform 0.8s; }
        .carousel-item { position: absolute; width: 100%; height: 100%; left: 0; top: 0; border-radius: 12px; border: 2px solid #333; overflow: hidden; box-shadow: 0 10px 30px rgba(0,0,0,0.5); cursor: pointer; }
        .carousel-item img { width: 100%; height: 100%; object-fit: cover; }

        /* GENRES (MULTI SELECT) */
        .genres { display: flex; gap: 10px; padding: 15px 20px; overflow-x: auto; scrollbar-width: none; }
        .chip { background: #222; padding: 8px 18px; border-radius: 20px; border: 1px solid #333; font-size: 13px; white-space: nowrap; transition: 0.2s; cursor: pointer; color: #ccc; user-select: none; }
        .chip.active { background: var(--accent); border-color: var(--accent); color: white; }
        
        /* GRID - RESPONSIVE (Mobile 2, PC 5) */
        .grid { 
            display: grid; 
            grid-template-columns: repeat(2, 1fr); /* Mobile Default */
            gap: 15px; 
            padding: 20px; 
            min-height: 400px; 
        }

        /* PC / Laptop Media Query */
        @media (min-width: 768px) {
            .grid {
                grid-template-columns: repeat(5, 1fr); /* PC view */
                gap: 20px;
            }
            .carousel-scene { height: 400px; } /* Thoda bada carousel PC pe */
            .carousel { width: 240px; height: 360px; }
        }

        .card { background: var(--card-bg); border-radius: 10px; overflow: hidden; position: relative; cursor: pointer; transition: transform 0.2s; }
        .card:hover { transform: scale(1.03); z-index: 2; }
        .poster-box { width: 100%; aspect-ratio: 2/3; }
        .poster-box img { width: 100%; height: 100%; object-fit: cover; }
        .card-info { padding: 10px; font-size: 13px; font-weight: bold; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .card-sub { font-size: 11px; color: #888; margin-top: 4px; }

        /* PAGINATION */
        .pagination { grid-column: 1 / -1; display: flex; justify-content: center; align-items: center; gap: 8px; padding: 20px 0; flex-wrap: wrap; }
        .page-btn { background: #222; border: 1px solid #333; color: #aaa; min-width: 35px; height: 35px; border-radius: 6px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 12px; transition: 0.2s; }
        .page-btn:hover { background: #333; color: white; }
        .page-btn.active { background: var(--accent); border-color: var(--accent); color: white; }
        .page-btn:disabled { opacity: 0.4; cursor: not-allowed; }

        /* MODAL */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 100; display: none; overflow-y: auto; }
        .modal.open { display: block; }
        .modal-hero { height: 45vh; position: relative; }
        .hero-img { width: 100%; height: 100%; object-fit: cover; mask-image: linear-gradient(to bottom, black 50%, transparent 100%); -webkit-mask-image: linear-gradient(to bottom, black 50%, transparent 100%); }
        .video-box { width: 100%; height: 100%; background: black; display: none; }
        .video-box iframe { width: 100%; height: 100%; border: none; }
        .modal-body { padding: 0 20px 50px; margin-top: -50px; position: relative; z-index: 5; }
        .m-title { font-size: 26px; font-weight: 800; margin-bottom: 5px; text-shadow: 0 2px 10px black; }
        .m-meta { font-size: 12px; color: #aaa; margin-bottom: 15px; }
        .btns { display: flex; gap: 10px; margin: 20px 0; }
        .btn { flex: 1; padding: 12px; border-radius: 6px; border: none; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .btn-play { background: white; color: black; }
        .btn-list { background: #333; color: white; }
        .btn-list.added { border: 1px solid var(--accent); color: var(--accent); }
        .close-fab { position: absolute; top: 20px; right: 20px; width: 40px; height: 40px; background: rgba(50,50,50,0.8); border-radius: 50%; color: white; border: none; font-size: 18px; z-index: 10; cursor: pointer; }
        .dl-sheet { background: #222; border-radius: 8px; margin-top: 15px; overflow: hidden; display: none; border: 1px solid #333; animation: slideDown 0.3s ease; }
        .dl-sheet.show { display: block; }
        .dl-header { padding: 10px 15px; background: #2a2a2a; font-size: 12px; color: #aaa; text-transform: uppercase; letter-spacing: 1px; border-bottom: 1px solid #333; }
        .dl-item { display: flex; justify-content: space-between; align-items: center; padding: 15px; border-bottom: 1px solid #333; color: white; text-decoration: none; transition: 0.2s; }
        .dl-badge { background: var(--accent); padding: 3px 8px; border-radius: 4px; font-size: 10px; font-weight: bold; }

        /* NAV BAR */
        .nav-bar { position: fixed; bottom: 0; width: 100%; height: 65px; background: rgba(15,15,15,0.95); backdrop-filter: blur(10px); display: flex; justify-content: space-around; align-items: center; border-top: 1px solid #333; z-index: 90; }
        .nav-item { color: #666; font-size: 10px; display: flex; flex-direction: column; align-items: center; cursor: pointer; }
        .nav-item i { font-size: 22px; margin-bottom: 4px; }
        .nav-item.active { color: white; }
        
        @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

    <header>
        <div class="logo">Moviezonex</div>
        <div class="search-container">
            <input type="text" id="search-input" placeholder="Search...">
            <button class="search-btn" onclick="toggleSearch()"><i class="fas fa-search"></i></button>
        </div>
    </header>

    <div id="main-view">
        <div class="carousel-scene"><div class="carousel" id="carousel"></div></div>

        <div class="genres">
            <div class="chip active" id="chip-all" onclick="filter('All', this)">All</div>
            <div class="chip" onclick="filter('Bollywood', this)">Bollywood</div>
            <div class="chip" onclick="filter('Hollywood', this)">Hollywood</div>
            <div class="chip" onclick="filter('Hindi Dubbed', this)">Hindi Dubbed</div>
            <div class="chip" onclick="filter('South Hindi', this)">South Hindi</div>
            <div class="chip" onclick="filter('Web Series', this)">Web Series</div>
            <div class="chip" onclick="filter('18+', this)">18+</div>
        </div>

        <div class="grid" id="grid"><p style="padding:20px; color:#666;">Loading...</p></div>
    </div>

    <div id="modal" class="modal">
        <button class="close-fab" onclick="closeModal()"><i class="fas fa-chevron-down"></i></button>
        <div class="modal-hero">
            <div class="video-box" id="vid-box"><iframe id="iframe" src="" allowfullscreen></iframe></div>
            <img src="" class="hero-img" id="hero-img">
        </div>
        <div class="modal-body">
            <h1 class="m-title" id="m-title">Title</h1>
            <div class="m-meta"><span id="m-genre">Genre</span></div>
            <div class="btns">
                <button class="btn btn-play" id="btn-play"><i class="fas fa-play"></i> Play</button>
                <button class="btn btn-list" id="btn-list" onclick="toggleFav()"><i class="fas fa-plus"></i> My List</button>
                <button class="btn btn-list" id="btn-dl"><i class="fas fa-download"></i> Download</button>
            </div>
            <div id="dl-options" class="dl-sheet"></div>
            <p style="color:#ccc; line-height:1.6; font-size:14px; margin-top:20px;" id="m-desc">Desc...</p>
        </div>
    </div>

    <nav class="nav-bar">
        <div class="nav-item active" onclick="switchTab('home')"><i class="fas fa-home"></i> Home</div>
        <div class="nav-item" onclick="switchTab('fav')"><i class="fas fa-heart"></i> My List</div>
    </nav>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCUpg_pySeXWhnj1EGYw1dRaETDBE33Xuw",
            authDomain: "amit-movie-app.firebaseapp.com",
            databaseURL: "https://amit-movie-app-default-rtdb.firebaseio.com",
            projectId: "amit-movie-app",
            storageBucket: "amit-movie-app.firebasestorage.app",
            messagingSenderId: "632726485738",
            appId: "1:632726485738:web:92feba50fc97a10f397593"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let movies = [];
        let currentList = [];
        let curMovie = null;
        let cIdx = 0;
        let view = 'home';
        let currentPage = 1;
        const itemsPerPage = 50;
        let carouselInterval;

        // DB Listener
        db.ref('movies').on('value', s => {
            const d = s.val();
            if(d) {
                movies = Object.keys(d).map(k => ({id:k, ...d[k]})).reverse();
                if(view === 'home') { 
                    currentList = movies; 
                    render(currentList); 
                    initCarousel(movies.slice(0,5)); 
                }
                
                if(window.location.hash.startsWith('#movie')) {
                    const savedId = localStorage.getItem('lastMovieId');
                    if(savedId) {
                        const m = movies.find(x => x.id === savedId);
                        if(m) openModal(m, false);
                    }
                }
            } else document.getElementById('grid').innerHTML = "<p style='padding:20px; color:#666;'>No movies found.</p>";
        });

        // FILTER LOGIC
        function filter(g, btn) {
            const allChip = document.getElementById('chip-all');
            if (g === 'All') {
                document.querySelectorAll('.chip').forEach(c => c.classList.remove('active'));
                btn.classList.add('active');
            } else {
                if (btn.classList.contains('active')) btn.classList.remove('active');
                else btn.classList.add('active');
                allChip.classList.remove('active');
                if (document.querySelectorAll('.chip.active').length === 0) allChip.classList.add('active');
            }

            const activeElements = document.querySelectorAll('.chip.active');
            let selectedTags = [];
            activeElements.forEach(el => selectedTags.push(el.innerText.trim()));

            document.getElementById('search-input').value = '';
            currentPage = 1;

            if (selectedTags.includes('All') || selectedTags.length === 0) {
                currentList = movies;
            } else {
                currentList = movies.filter(m => {
                    if (!m.genre) return false;
                    const mGenres = m.genre.toLowerCase();
                    return selectedTags.every(tag => mGenres.includes(tag.toLowerCase()));
                });
            }
            render(currentList);
        }

        // RENDER & PAGE
        function render(list) {
            const g = document.getElementById('grid'); 
            
            if(list.length === 0) {
                g.innerHTML = '<p style="padding:20px; color:#666; grid-column: 1 / -1;">No movies found.</p>';
                return;
            }
            
            const start = (currentPage - 1) * itemsPerPage;
            const end = start + itemsPerPage;
            const visibleList = list.slice(start, end);

            let html = visibleList.map(m => `
                <div class="card" onclick='openModal(${JSON.stringify(m).replace(/'/g, "&#39;")})'>
                    <div class="poster-box">
                        <img src="${m.poster}" loading="lazy" onerror="this.src='https://via.placeholder.com/200'">
                    </div>
                    <div class="card-info">${m.title}</div>
                    <div class="card-info card-sub">${m.genre}</div>
                </div>
            `).join('');

            const totalPages = Math.ceil(list.length / itemsPerPage);
            if(totalPages > 1) {
                html += `<div class="pagination">
                    <button class="page-btn" onclick="changePage(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}><i class="fas fa-chevron-left"></i></button>`;
                for(let i = 1; i <= totalPages; i++) {
                    if (i === 1 || i === totalPages || (i >= currentPage - 1 && i <= currentPage + 1)) {
                         html += `<button class="page-btn ${i === currentPage ? 'active' : ''}" onclick="changePage(${i})">${i}</button>`;
                    } else if (i === currentPage - 2 || i === currentPage + 2) {
                        html += `<span style="color:#666;">...</span>`;
                    }
                }
                html += `<button class="page-btn" onclick="changePage(${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''}><i class="fas fa-chevron-right"></i></button>
                </div>`;
            }
            g.innerHTML = html;
        }

        function changePage(p) {
            const totalPages = Math.ceil(currentList.length / itemsPerPage);
            if(p < 1 || p > totalPages) return;
            currentPage = p;
            render(currentList);
            document.querySelector('.genres').scrollIntoView({behavior: 'smooth'});
        }

        function toggleSearch() {
            const input = document.getElementById('search-input');
            input.classList.toggle('active');
            if(input.classList.contains('active')) {
                input.focus();
            } else {
                input.value = '';
                currentPage = 1;
                document.querySelectorAll('.chip').forEach(c => c.classList.remove('active'));
                document.getElementById('chip-all').classList.add('active');
                currentList = movies;
                render(movies); 
            }
        }

        document.getElementById('search-input').addEventListener('keyup', (e) => {
            const val = e.target.value.toLowerCase();
            currentPage = 1;
            document.querySelectorAll('.chip').forEach(c => c.classList.remove('active'));
            currentList = movies.filter(m => 
                (m.title && m.title.toLowerCase().includes(val)) || 
                (m.genre && m.genre.toLowerCase().includes(val))
            );
            render(currentList);
        });

        function switchTab(v) {
            view = v;
            currentPage = 1; 
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            
            if(v === 'home') {
                document.querySelectorAll('.nav-item')[0].classList.add('active');
                currentList = movies;
                render(currentList);
                document.querySelector('.carousel-scene').style.display = 'flex';
                document.querySelector('.genres').style.display = 'flex';
            } else {
                document.querySelectorAll('.nav-item')[1].classList.add('active');
                currentList = JSON.parse(localStorage.getItem('favs')) || [];
                render(currentList);
                document.querySelector('.carousel-scene').style.display = 'none';
                document.querySelector('.genres').style.display = 'none';
            }
        }

        function initCarousel(list) {
            const c = document.getElementById('carousel'); c.innerHTML = '';
            if(!list.length) return;
            const theta = 360/list.length;
            const rad = Math.round(150 / Math.tan(Math.PI/list.length));
            list.forEach((m,i) => {
                c.innerHTML += `<div class="carousel-item" onclick='openModal(${JSON.stringify(m).replace(/'/g, "&#39;")})' style="transform: rotateY(${theta*i}deg) translateZ(${rad+50}px)">
                    <img src="${m.poster}">
                </div>`;
            });
            if (carouselInterval) clearInterval(carouselInterval);
            carouselInterval = setInterval(() => { cIdx++; c.style.transform = `rotateY(${theta*cIdx*-1}deg)`; }, 3500);
        }

        // --- MODAL, PLAY & DOWNLOAD ---
        function openModal(m, push = true) {
            curMovie = m;
            localStorage.setItem('lastMovieId', m.id);
            if(push) window.history.pushState({modal:true}, null, "#movie");
            if (carouselInterval) clearInterval(carouselInterval);

            document.getElementById('m-title').innerText = m.title;
            document.getElementById('m-genre').innerText = m.genre;
            document.getElementById('m-desc').innerText = m.description;
            document.getElementById('hero-img').src = m.poster;
            document.getElementById('hero-img').style.display = 'block';
            document.getElementById('vid-box').style.display = 'none';
            document.getElementById('iframe').src = "";
            document.getElementById('dl-options').classList.remove('show');

            // Play Logic
            document.getElementById('btn-play').onclick = () => {
                if(!m.playUrl) return alert("No Stream Link");
                let url = m.playUrl;
                if(url.includes('youtu')) {
                    const idMatch = url.match(/(?:youtu\.be\/|youtube\.com(?:\/embed\/|\/v\/|\/watch\?v=|\/user\/\S+|\/ytscreeningroom\?v=))([\w\-]{10,12})\b/);
                    if(idMatch) url = `https://www.youtube.com/embed/${idMatch[1]}?autoplay=1`;
                }
                document.getElementById('hero-img').style.display = 'none';
                document.getElementById('vid-box').style.display = 'block';
                document.getElementById('iframe').src = url;
            };

            // Download Logic
            document.getElementById('btn-dl').onclick = () => {
                const sheet = document.getElementById('dl-options');
                if(sheet.classList.contains('show')) { sheet.classList.remove('show'); return; }
                if(!m.downloadUrl) return alert("No download links available.");

                let html = '<div class="dl-header">Select Quality</div>';
                const links = m.downloadUrl.split(',');
                links.forEach(link => {
                    let cleanLink = link.trim();
                    let label = "Download";
                    let url = cleanLink;
                    if(cleanLink.includes('http') && cleanLink.indexOf('http') > 0) {
                        const parts = cleanLink.split('http');
                        label = parts[0].replace(/[:]/g, '').trim();
                        url = 'http' + parts[1];
                    }
                    html += `<a href="${url}" target="_blank" class="dl-item">
                        <span>${label}</span> <span class="dl-badge"><i class="fas fa-download"></i></span>
                    </a>`;
                });
                sheet.innerHTML = html;
                sheet.classList.add('show');
            };

            checkFavStatus();
            document.getElementById('modal').classList.add('open');
        }

        function closeModal() {
            if(window.location.hash === "#movie") window.history.back();
            else hideModalUI();
        }

        function hideModalUI() {
            const m = document.getElementById('modal');
            m.classList.remove('open');
            document.getElementById('iframe').src = "";
            document.getElementById('vid-box').style.display = 'none';
            document.getElementById('hero-img').style.display = 'block';
            if(view === 'home' && !carouselInterval) {
                 const list = movies.slice(0,5);
                 if(list.length) initCarousel(list);
            }
        }

        window.onpopstate = () => {
            if(!window.location.hash.startsWith('#movie')) {
                hideModalUI();
                localStorage.removeItem('lastMovieId');
            }
        };

        function toggleFav() {
            if(!curMovie) return;
            let favs = JSON.parse(localStorage.getItem('favs')) || [];
            const idx = favs.findIndex(x => x.id === curMovie.id);
            if(idx > -1) favs.splice(idx, 1);
            else favs.push(curMovie);
            
            localStorage.setItem('favs', JSON.stringify(favs));
            checkFavStatus();
            if(view === 'fav') { currentList = favs; render(currentList); }
        }

        function checkFavStatus() {
            if(!curMovie) return;
            const favs = JSON.parse(localStorage.getItem('favs')) || [];
            const found = favs.find(x => x.id === curMovie.id);
            const btn = document.getElementById('btn-list');
            if(found) {
                btn.classList.add('added');
                btn.innerHTML = '<i class="fas fa-check"></i> Added';
            } else {
                btn.classList.remove('added');
                btn.innerHTML = '<i class="fas fa-plus"></i> My List';
            }
        }
    </script>
</body>
</html>
